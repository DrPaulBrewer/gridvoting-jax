# Changelog

All notable changes to this project will be documented in this file. This file and most of the code changes are AI generated by Antigravity, an AI coding assistant created by Google DeepMind's Advanced Agentic Coding team.  This is a private project and no association with Google or Alphabet Inc. is implied.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),

## [Unreleased]

### Changed - 2025-12-17

- **Refactored `solve_for_unit_eigenvector()` method**: Extracted negative probability correction logic into reusable helper function
- **Created `_move_neg_prob_to_max()` helper function**: JIT-compiled pure function that redistributes mass from negative components to maximum-value indices
- **Fixed mass redistribution bug**: Mass now distributed equally among **all** indices sharing the maximum value (within TOLERANCE), not just a single index
- **Removed diagnostic warnings**: Eliminated 4 unnecessary warnings from `solve_for_unit_eigenvector()` while preserving exception-related warnings
- **JAX JIT compatibility**: Implemented using `jnp.where()` instead of boolean indexing to ensure JIT compilation compatibility
- **Used TOLERANCE constant**: Applied module-level `TOLERANCE` (5e-5) for float32-compatible floating-point comparisons

### Technical Details

- Helper function uses immutable JAX operations for all array manipulations
- Correctly handles edge case where multiple indices have identical maximum values
- Cleaner separation of concerns: negative component correction isolated from eigenvector solving
- All 23 tests pass (100% success rate)
- Verified with NumPy 2.3.5 and JAX 0.4.20+ in isolated Docker environment

- **Created benchmarks submodule**: Moved standalone `benchmarks/` directory into package as `gridvoting_jax.benchmarks`
- **Added `benchmarks.performance()` function**: Accessible via `gv.benchmarks.performance()` for running performance benchmarks
- **Flexible output format**: `performance(dict=True)` returns results dictionary; `performance()` (default) prints formatted output
- **Removed unused NumPy import**: Eliminated unnecessary `import numpy as np` from benchmark code
- **Deleted standalone benchmarks directory**: Cleaned up project structure by removing redundant `benchmarks/` directory
- **Added benchmark test**: Created `test_benchmarks.py` to verify submodule functionality
- **Marked benchmark test as slow**: Added `@pytest.mark.slow` decorator to allow skipping long-running benchmark tests
- **Updated GitHub workflows**: Modified CI workflows to skip slow tests with `-m "not slow"` for faster CI runs

### Technical Details

- Benchmarks submodule uses relative imports from parent package
- Function returns structured dictionary with device info, JAX version, and per-test results
- Supports future expansion with additional benchmark functions
- All 23 tests pass (100% success rate) including new benchmark test
- Verified with NumPy 2.3.5 and JAX 0.4.20+ in isolated Docker environment


- **Grid class fully migrated to JAX arrays**: All Grid properties (`x`, `y`, `points`, `boundary`) now use `jnp.array` instead of `np.array`
- **Removed all assert statements from Grid class**: Eliminated 12 runtime assertions; JAX operations provide natural error handling for shape mismatches
- **Replaced barycentric triangle algorithm with cross-product method**: Implemented simpler, more robust half-plane test for `within_triangle()` using cross products
- **Added `_is_in_triangle_single()` helper function**: JIT-compiled cross-product triangle containment test with epsilon tolerance for edge/vertex cases
- **Vectorized triangle testing**: Used `jax.vmap` to efficiently apply triangle test across all grid points
- **Updated `embedding()` method**: Now uses JAX immutable update pattern (`.at[].set()`) instead of in-place assignment
- **Updated `extremes()` method**: Converted to use `jnp.full` and `jnp.abs` for JAX compatibility
- **Enhanced `plot()` method**: Automatically converts JAX arrays to NumPy for matplotlib compatibility
- **Updated test suite**: Converted test constants to `jnp.array` and replaced `np.testing.assert_array_equal` with `jnp.array_equal`

### Technical Details

- Cross-product algorithm based on [Stack Overflow answer](https://stackoverflow.com/a/2049593/103081) by Kornel Kisielewicz
- Epsilon tolerance of 1e-10 for robust edge/vertex handling in triangle containment
- All Grid methods now return JAX arrays (breaking change from NumPy arrays)
- Functional programming paradigm: no in-place modifications, immutable updates only
- All 22 tests pass (100% success rate)
- Verified with NumPy 2.3.5 and JAX 0.4.20+ in isolated Docker environment

### Changed - 2025-12-16

- **Removed pandas dependency**: Eliminated pandas from requirements; replaced `pd.Series().plot()` and `pd.DataFrame()` calls with direct matplotlib plotting
- **Removed scipy dependency**: Eliminated scipy from requirements; replaced `scipy.spatial.distance.cdist` with custom JAX implementations
- **Implemented JAX distance functions**: Added JIT-compiled `dist_sqeuclidean()` and `dist_manhattan()` functions for improved performance
- **Eliminated xp abstraction pattern**: Removed `xp` variable; now use `np` explicitly for NumPy operations and `jnp` explicitly for JAX operations
- **Removed diagnostic plotting code**: Removed power method diagnostics plotting that referenced non-existent attributes
- **Updated Grid methods**: Modified `spatial_utilities()` and `within_disk()` to use JAX distance functions with support for 'sqeuclidean' and 'manhattan' metrics
- **Updated test files**: Removed xp references from all test files; tests now import `jax.numpy as jnp` directly where needed

### Technical Details

- All `xp.asnumpy()` calls replaced with `np.array()`
- Distance calculations now use `@jax.jit` decorator for compilation optimization
- Maintained full backward compatibility - all 22 tests pass
- Verified with NumPy 2.3.5 and JAX 0.4.20+ in isolated Docker environment

